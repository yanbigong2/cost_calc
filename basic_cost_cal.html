<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒç”Ÿæ´»æˆæœ¬ä¸æ”¶å…¥é”šå®šè®¡ç®—å™¨ (å¤šè´§å¸ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --border: #e2e8f0;
            --text: #1e293b;
            --header-bg: #f1f5f9;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        h1, h2 { margin-top: 0; color: #0f172a; }
        .control-panel { display: flex; flex-wrap: wrap; gap: 20px; align-items: center; margin-bottom: 20px; padding: 15px; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe; }
        
        .control-group { display: flex; align-items: center; gap: 8px; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; min-width: 120px; }

        /* Tables */
        .table-wrapper { overflow-x: auto; margin-bottom: 30px; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 1100px; }
        th, td { padding: 10px 12px; text-align: right; border-bottom: 1px solid var(--border); }
        th { background: var(--header-bg); font-weight: 600; text-align: center; white-space: nowrap; }
        th.text-left, td.text-left { text-align: left; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8fafc; }

        /* Inputs */
        input[type="number"] { width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: right; font-family: monospace; }
        input[type="number"]:focus { outline: 2px solid var(--primary); border-color: var(--primary); }
        
        /* Global Inputs (The Driver) */
        .driver-inputs th { background: #1e293b; color: white; padding: 15px; }
        .driver-inputs input { background: #334155; border: 1px solid #475569; color: white; font-size: 16px; font-weight: bold; }
        
        /* Toggles */
        .toggle-btn { cursor: pointer; background: white; border: 1px solid #cbd5e1; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; }
        .toggle-btn.active { background: #dbeafe; color: var(--primary); border-color: var(--primary); }
        
        .sub-label { font-size: 10px; color: #64748b; font-weight: normal; display: block; margin-top: 2px; }
        
        .negative { color: #dc2626; font-weight: bold; }
        .positive { color: #16a34a; font-weight: bold; }

        /* Cost specific inputs */
        .cost-input-group { display: flex; gap: 4px; justify-content: flex-end; }
        .cost-input-group input { width: 70px; text-align: center; }
        .cost-input-group span { align-self: center; color: #94a3b8; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
        <h1>å…¨çƒç”Ÿæ´»æˆæœ¬é”šå®šè®¡ç®—å™¨</h1>
        <div class="control-panel" style="margin-bottom:0;">
            <div class="control-group">
                <label style="font-weight:bold;">å®¶åº­æ¨¡å¼ï¼š</label>
                <select id="modeSelect" onchange="changeMode()">
                    <option value="single">å•äºº (Single)</option>
                    <option value="family">å®¶åº­ (Family - 2äºº1å­©)</option>
                </select>
            </div>
            <div class="control-group">
                <label style="font-weight:bold;">è´§å¸å•ä½ï¼š</label>
                <select id="currencySelect" onchange="changeCurrency()">
                    <option value="USD">ğŸ‡ºğŸ‡¸ ç¾å…ƒ (USD)</option>
                    <option value="CNY">ğŸ‡¨ğŸ‡³ äººæ°‘å¸ (CNY)</option>
                    <option value="HKD">ğŸ‡­ğŸ‡° æ¸¯å¸ (HKD)</option>
                    <option value="GBP">ğŸ‡¬ğŸ‡§ è‹±é•‘ (GBP)</option>
                    <option value="AED">ğŸ‡¦ğŸ‡ª è¿ªæ‹‰å§† (AED)</option>
                </select>
            </div>
        </div>
    </div>

    <p style="color:#64748b; font-size: 13px; margin-bottom: 20px;">
        è¯´æ˜ï¼šæ‰€æœ‰é‡‘é¢å°†æ ¹æ®æ‰€é€‰è´§å¸è‡ªåŠ¨æ¢ç®—ã€‚åœ¨è“è‰²åŒºåŸŸè¾“å…¥ä»»æ„ä¸€é¡¹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åæ¨å…¶ä»–åˆ—ã€‚
    </p>

    <h2>ç”Ÿæ´»æˆæœ¬æ˜ç»†è¡¨ (æœˆåº¦/å¹´åº¦)</h2>
    <p style="font-size:12px; color:#64748b;">
        <span style="display:inline-flex; align-items:center; gap:4px; background:#dbeafe; padding:2px 6px; border-radius:4px; color:#2563eb;">ğŸ”— è”åŠ¨å¼€å¯</span> 
        ä¿®æ”¹ä»»æ„åŸå¸‚æ•°å€¼ï¼Œå…¶ä»–åŸå¸‚æŒ‰å½“å‰æ¯”ä¾‹è‡ªåŠ¨è°ƒæ•´ã€‚ç‚¹å‡»æŒ‰é’®è§£é” ğŸ”“ å¯å•ç‹¬ä¿®æ”¹ã€‚
        <br><b>æ³¨æ„ï¼š</b> ä¸‹æ–¹è¾“å…¥æ¡†ä¸­çš„é‡‘é¢ä¸º<b>å½“å‰é€‰æ‹©è´§å¸</b>ã€‚
    </p>

    <!-- æˆæœ¬æ˜ç»†è¡¨ -->
    <div class="table-wrapper">
        <table id="costTable">
            <thead>
                <tr>
                    <th class="text-left" style="width:120px;">åŸå¸‚</th>
                    
                    <!-- æˆ¿ç§Ÿ -->
                    <th style="min-width:200px;">
                        <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                            ğŸ  æˆ¿ç§Ÿ (æœˆ)
                            <button class="toggle-btn active" id="link-rent" onclick="toggleLink('rent')">ğŸ”—</button>
                        </div>
                        <span class="sub-label">é¢ç§¯(ã¡) Ã— å•ä»·<span class="currency-label"></span></span>
                    </th>

                    <!-- äº¤é€š -->
                    <th style="min-width:180px;">
                        <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                            ğŸš— äº¤é€š (æœˆ)
                            <button class="toggle-btn active" id="link-transport" onclick="toggleLink('transport')">ğŸ”—</button>
                        </div>
                        <span class="sub-label">å…¬äº¤ + æ‰“è½¦</span>
                    </th>

                    <!-- é¤é¥® -->
                    <th style="min-width:240px;">
                        <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                            ğŸ” é¤é¥® (æœˆ)
                            <button class="toggle-btn active" id="link-food" onclick="toggleLink('food')">ğŸ”—</button>
                        </div>
                        <span class="sub-label">è‡ªåš(é¡¿Ã—å•ä»·) + å¤–é£Ÿ(é¡¿Ã—å•ä»·)</span>
                    </th>

                    <!-- ç¤¾äº¤ -->
                    <th style="min-width:120px;">
                        <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                            ğŸ· ç¤¾äº¤é…’æ°´ (æœˆ)
                            <button class="toggle-btn active" id="link-social" onclick="toggleLink('social')">ğŸ”—</button>
                        </div>
                    </th>

                    <!-- æ‚è´¹ -->
                    <th style="min-width:120px;">
                        <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                            ğŸ›’ æ—¥ç”¨/æ‚è´§ (æœˆ)
                            <button class="toggle-btn active" id="link-misc" onclick="toggleLink('misc')">ğŸ”—</button>
                        </div>
                    </th>

                    <!-- æ—…æ¸¸ -->
                    <th style="min-width:120px;">
                        <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                            âœˆï¸ ä¼‘é—²æ—…æ¸¸ (å¹´)
                            <button class="toggle-btn active" id="link-travel" onclick="toggleLink('travel')">ğŸ”—</button>
                        </div>
                    </th>

                    <th style="background:#f1f5f9;">æ€»è®¡ (å¹´)</th>
                </tr>
            </thead>
            <tbody id="costTableBody">
                <!-- JS æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>

    <h2>æ”¶å…¥ä¸å‚¨è“„å¯¹æ¯”è¡¨</h2>
    <p style="font-size:12px; color:#64748b; margin-bottom: 10px;">
        åœ¨è“è‰²åŒºåŸŸè¾“å…¥ä»»æ„ä¸€é¡¹ï¼ˆç¨å‰/ç¨å/å€æ•°/Big Macï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åæ¨å…¶ä»–åˆ—ã€‚
        <br>å¹´ç”Ÿæ´»æ¶ˆè´¹æ¥è‡ªä¸Šæ–¹æ˜ç»†è¡¨è®¡ç®—ç»“æœã€‚
    </p>

    <!-- ä¸»æ•°æ®è¡¨ -->
    <div class="table-wrapper">
        <table id="mainTable">
            <thead>
                <!-- é©±åŠ¨è¾“å…¥è¡Œ -->
                <tr class="driver-inputs">
                    <th class="text-left" style="width: 150px;">ç»Ÿä¸€åŸºå‡†è®¾å®š â”</th>
                    <th>
                        <div>ç¨å‰å¹´è–ª <span class="currency-label">(USD)</span></div>
                        <input type="number" id="globalPreTax" placeholder="è¾“å…¥..." onchange="handleGlobalInput('preTax', this.value)">
                    </th>
                    <th>
                        <div>ç¨åå¹´è–ª <span class="currency-label">(USD)</span></div>
                        <input type="number" id="globalPostTax" placeholder="è¾“å…¥..." onchange="handleGlobalInput('postTax', this.value)">
                    </th>
                    <!-- ç§»åŠ¨åçš„ä½ç½®ï¼šå½“åœ°æ”¶å…¥å€æ•° -->
                    <th>
                        <div>å½“åœ°æ”¶å…¥å€æ•° (ç¨å‰)</div>
                        <input type="number" id="globalMultiple" placeholder="è¾“å…¥..." onchange="handleGlobalInput('multiple', this.value)">
                    </th>
                    <!-- ç§»åŠ¨åçš„ä½ç½®ï¼šBig Mac -->
                    <th>
                        <div>Big Mac è´­ä¹°åŠ› (ä¸ª)</div>
                        <input type="number" id="globalBigMac" placeholder="è¾“å…¥..." onchange="handleGlobalInput('bigMac', this.value)">
                    </th>
                    <th style="background: #334155;">
                        <div style="opacity:0.5">å¹´ç”Ÿæ´»æ€»æˆæœ¬</div>
                        <div style="font-size:12px; font-weight:normal; margin-top:5px;">(è§ä¸Šæ–¹æ˜ç»†è¡¨)</div>
                    </th>
                    <th style="background: #334155;">
                        <div style="opacity:0.5">å¹´ç»“ä½™</div>
                        <div style="font-size:12px; font-weight:normal; margin-top:5px;">(ç¨å - æˆæœ¬)</div>
                    </th>
                </tr>
                <!-- è¡¨å¤´ -->
                <tr>
                    <th class="text-left">åŸå¸‚</th>
                    <th>ç¨å‰å¹´è–ª <span class="currency-label"></span></th>
                    <th>ç¨åå¹´è–ª <span class="currency-label"></span><br><span class="sub-label">å«é˜¶æ¢¯ç¨ç‡/ç¤¾ä¿</span></th>
                    <th>å½“åœ°æ”¶å…¥å€æ•°<br><span class="sub-label">ç¨å‰ / å½“åœ°å¹³å‡</span></th>
                    <th>Big Mac æŒ‡æ•°<br><span class="sub-label">ç¨å / å•ä»·</span></th>
                    <th>å¹´ç”Ÿæ´»æ¶ˆè´¹ <span class="currency-label"></span><br><span class="sub-label">æ¥è‡ªä¸Šæ–¹æ˜ç»†</span></th>
                    <th>å¹´ç»“ä½™ <span class="currency-label"></span><br><span class="sub-label">å‚¨è“„æ½œåŠ›</span></th>
                </tr>
            </thead>
            <tbody id="mainTableBody">
                <!-- JS æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // --- 1. åŸºç¡€æ•°æ®é…ç½® (åŸºå‡†ä¸º USD) ---
    const CITIES_CONFIG = {
        nyc: { name: "ğŸ‡ºğŸ‡¸ çº½çº¦", bigMac: 5.69, avgIncome: 85000, taxRegion: 'us_ny' },
        ldn: { name: "ğŸ‡¬ğŸ‡§ ä¼¦æ•¦", bigMac: 5.39, avgIncome: 58000, taxRegion: 'uk' },
        hk:  { name: "ğŸ‡­ğŸ‡° é¦™æ¸¯", bigMac: 2.95, avgIncome: 38000, taxRegion: 'hk' },
        dxb: { name: "ğŸ‡¦ğŸ‡ª è¿ªæ‹œ", bigMac: 4.90, avgIncome: 50000, taxRegion: 'uae' },
        sh:  { name: "ğŸ‡¨ğŸ‡³ ä¸Šæµ·", bigMac: 3.56, avgIncome: 24000, taxRegion: 'cn' }
    };

    const CURRENCIES = {
        USD: { rate: 1, symbol: '$' },
        CNY: { rate: 7.23, symbol: 'Â¥' },
        HKD: { rate: 7.82, symbol: 'HK$' },
        GBP: { rate: 0.79, symbol: 'Â£' },
        AED: { rate: 3.67, symbol: 'AED' }
    };

    // é»˜è®¤ç”Ÿæ´»æˆæœ¬ (USD)
    // é¤é¥®é¡¿æ•°ç»Ÿä¸€ä¸º 30 (åœ¨å®¶) + 30 (åœ¨å¤–)
    const DEFAULTS = {
        single: {
            nyc: { rentArea: 50, rentPrice: 70, transPub: 130, transTaxi: 400, foodHomeMeals: 30, foodHomePrice: 15, foodOutMeals: 30, foodOutPrice: 40, social: 800, misc: 600, travel: 3000 },
            ldn: { rentArea: 50, rentPrice: 50, transPub: 200, transTaxi: 100, foodHomeMeals: 30, foodHomePrice: 10, foodOutMeals: 30, foodOutPrice: 35, social: 700, misc: 500, travel: 2500 },
            hk:  { rentArea: 35, rentPrice: 60, transPub: 80, transTaxi: 200, foodHomeMeals: 30, foodHomePrice: 10, foodOutMeals: 30, foodOutPrice: 15, social: 800, misc: 300, travel: 2000 },
            dxb: { rentArea: 60, rentPrice: 30, transPub: 0, transTaxi: 600, foodHomeMeals: 30, foodHomePrice: 12, foodOutMeals: 30, foodOutPrice: 30, social: 1000, misc: 400, travel: 2500 },
            sh:  { rentArea: 60, rentPrice: 25, transPub: 30, transTaxi: 150, foodHomeMeals: 30, foodHomePrice: 6, foodOutMeals: 30, foodOutPrice: 10, social: 400, misc: 200, travel: 1500 }
        },
        family: {
            nyc: { rentArea: 100, rentPrice: 65, transPub: 260, transTaxi: 600, foodHomeMeals: 30, foodHomePrice: 24, foodOutMeals: 30, foodOutPrice: 80, social: 1200, misc: 1500, travel: 8000 },
            ldn: { rentArea: 100, rentPrice: 45, transPub: 300, transTaxi: 200, foodHomeMeals: 30, foodHomePrice: 18, foodOutMeals: 30, foodOutPrice: 70, social: 1000, misc: 1200, travel: 7000 },
            hk:  { rentArea: 80, rentPrice: 55, transPub: 150, transTaxi: 400, foodHomeMeals: 30, foodHomePrice: 20, foodOutMeals: 30, foodOutPrice: 30, social: 1200, misc: 800, travel: 6000 },
            dxb: { rentArea: 120, rentPrice: 30, transPub: 0, transTaxi: 1000, foodHomeMeals: 30, foodHomePrice: 22, foodOutMeals: 30, foodOutPrice: 60, social: 1500, misc: 1000, travel: 8000 },
            sh:  { rentArea: 120, rentPrice: 22, transPub: 60, transTaxi: 300, foodHomeMeals: 30, foodHomePrice: 12, foodOutMeals: 30, foodOutPrice: 25, social: 600, misc: 600, travel: 4000 }
        }
    };

    // --- 2. çŠ¶æ€ç®¡ç† ---
    let state = {
        mode: 'single',
        currency: 'USD',
        costs: JSON.parse(JSON.stringify(DEFAULTS.single)), // Stores USD values
        links: { rent: true, transport: true, food: true, social: true, misc: true, travel: true },
        incomes: { nyc: 100000, ldn: 100000, hk: 100000, dxb: 100000, sh: 100000 }, // Stores USD values
        // è®°å½•ä¸Šä¸€æ¬¡çš„è¾“å…¥å€¼ç±»å‹ï¼Œç”¨äºåˆ‡æ¢è´§å¸æ—¶åˆ·æ–°è¾“å…¥æ¡†
        lastInputType: 'preTax', 
        lastInputValue: 100000 // USD
    };

    // --- 3. è´§å¸è½¬æ¢å·¥å…· ---
    function getRate() {
        return CURRENCIES[state.currency].rate;
    }
    function getSymbol() {
        return CURRENCIES[state.currency].symbol;
    }
    // USD -> Selected Currency
    function toDisplay(usdValue) {
        return usdValue * getRate();
    }
    // Selected Currency -> USD
    function fromDisplay(displayValue) {
        return displayValue / getRate();
    }
    function formatMoney(usdValue) {
        return getSymbol() + toDisplay(usdValue).toLocaleString(undefined, {maximumFractionDigits:0});
    }

    // --- 4. ç¨åŠ¡å¼•æ“ (USD Base) ---
    function calculateNetIncome(gross, region) {
        if (gross <= 0) return 0;
        let tax = 0;
        
        if (region === 'uae') {
            return gross;
        } 
        else if (region === 'us_ny') {
            let fica = Math.min(gross, 168600) * 0.0765 + Math.max(0, gross - 168600) * 0.0145;
            let fed = 0;
            if (gross > 11000) fed += (Math.min(gross, 44000) - 11000) * 0.12;
            if (gross > 44000) fed += (Math.min(gross, 95000) - 44000) * 0.22;
            if (gross > 95000) fed += (Math.min(gross, 182000) - 95000) * 0.24;
            if (gross > 182000) fed += (Math.min(gross, 231000) - 182000) * 0.32;
            if (gross > 231000) fed += (Math.max(0, gross - 231000)) * 0.35;
            let stateCity = gross * 0.09; 
            tax = fica + fed + stateCity;
        } 
        else if (region === 'uk') {
            let ni = 0;
            if (gross > 12000) ni = (Math.min(gross, 60000) - 12000) * 0.10;
            if (gross > 60000) ni += (gross - 60000) * 0.02;
            let incomeTax = 0;
            if (gross > 16000) incomeTax += (Math.min(gross, 63000) - 16000) * 0.20;
            if (gross > 63000) incomeTax += (Math.min(gross, 150000) - 63000) * 0.40;
            if (gross > 150000) incomeTax += (gross - 150000) * 0.45;
            tax = ni + incomeTax;
        } 
        else if (region === 'hk') {
            let progressive = 0;
            let netAssessable = Math.max(0, gross - 20000);
            if (netAssessable > 0) progressive += Math.min(netAssessable, 6000) * 0.02;
            if (netAssessable > 6000) progressive += (Math.min(netAssessable, 12000) - 6000) * 0.06;
            if (netAssessable > 12000) progressive += (Math.min(netAssessable, 18000) - 12000) * 0.10;
            if (netAssessable > 18000) progressive += (Math.min(netAssessable, 24000) - 18000) * 0.14;
            if (netAssessable > 24000) progressive += (netAssessable - 24000) * 0.17;
            let standard = gross * 0.15;
            tax = Math.min(progressive, standard);
        }
        else if (region === 'cn') {
            let social = Math.min(gross * 0.175, 5000);
            let taxable = Math.max(0, gross - social - 10000);
            let it = 0;
            if (taxable > 0) it += Math.min(taxable, 6000) * 0.03;
            if (taxable > 6000) it += (Math.min(taxable, 20000) - 6000) * 0.10;
            if (taxable > 20000) it += (Math.min(taxable, 42000) - 20000) * 0.20;
            if (taxable > 42000) it += (Math.min(taxable, 60000) - 42000) * 0.25;
            if (taxable > 60000) it += (Math.min(taxable, 80000) - 60000) * 0.30;
            if (taxable > 80000) it += (Math.min(taxable, 110000) - 80000) * 0.35;
            if (taxable > 110000) it += (taxable - 110000) * 0.45;
            tax = social + it;
        }
        return gross - tax;
    }

    function calculateGrossFromNet(targetNet, region) {
        if (targetNet <= 0) return 0;
        if (region === 'uae') return targetNet;
        let low = targetNet;
        let high = targetNet * 3;
        let mid = 0;
        for (let i = 0; i < 20; i++) {
            mid = (low + high) / 2;
            let estimatedNet = calculateNetIncome(mid, region);
            if (estimatedNet < targetNet) {
                low = mid;
            } else {
                high = mid;
            }
        }
        return mid;
    }

    // --- 5. é€»è¾‘å¤„ç† ---

    function changeMode() {
        state.mode = document.getElementById('modeSelect').value;
        state.costs = JSON.parse(JSON.stringify(DEFAULTS[state.mode]));
        renderAll();
    }

    function changeCurrency() {
        state.currency = document.getElementById('currencySelect').value;
        // åˆ·æ–°è¾“å…¥æ¡†æ˜¾ç¤º
        refreshDriverInputs();
        renderAll();
    }

    function toggleLink(key) {
        state.links[key] = !state.links[key];
        const btn = document.getElementById(`link-${key}`);
        if (state.links[key]) {
            btn.classList.add('active');
            btn.innerText = 'ğŸ”—';
        } else {
            btn.classList.remove('active');
            btn.innerText = 'ğŸ”“';
        }
    }

    // æ ¸å¿ƒï¼šå¤„ç†å…¨å±€è¾“å…¥
    function handleGlobalInput(type, displayValue) {
        const val = parseFloat(displayValue);
        if (isNaN(val)) return;

        // è®°å½•çŠ¶æ€ä»¥ä¾¿åˆ‡æ¢è´§å¸æ—¶æ¢å¤
        state.lastInputType = type;
        
        // å°†è¾“å…¥å€¼ï¼ˆå½“å‰è´§å¸ï¼‰è½¬æ¢ä¸º USD
        let usdVal = fromDisplay(val);
        if (type === 'bigMac' || type === 'multiple') {
            usdVal = val; // è¿™äº›æ˜¯æ•°é‡æˆ–å€æ•°ï¼Œä¸æ¶‰åŠæ±‡ç‡
        }

        // æ¸…ç©ºå…¶ä»–è¾“å…¥æ¡† (è§†è§‰ä¸Š)
        if(type !== 'preTax') document.getElementById('globalPreTax').value = '';
        if(type !== 'postTax') document.getElementById('globalPostTax').value = '';
        if(type !== 'bigMac') document.getElementById('globalBigMac').value = '';
        if(type !== 'multiple') document.getElementById('globalMultiple').value = '';

        Object.keys(CITIES_CONFIG).forEach(cityKey => {
            const config = CITIES_CONFIG[cityKey];
            let calculatedGross = 0;

            if (type === 'preTax') {
                calculatedGross = usdVal;
            } else if (type === 'postTax') {
                calculatedGross = calculateGrossFromNet(usdVal, config.taxRegion);
            } else if (type === 'bigMac') {
                const targetNet = usdVal * config.bigMac;
                calculatedGross = calculateGrossFromNet(targetNet, config.taxRegion);
            } else if (type === 'multiple') {
                calculatedGross = usdVal * config.avgIncome;
            }
            state.incomes[cityKey] = calculatedGross;
        });

        // è®°å½•åŸºå‡†å€¼ç”¨äºåˆ·æ–°
        if(type === 'preTax') state.lastInputValue = usdVal; 
        
        renderAll();
    }

    function refreshDriverInputs() {
        // åˆ‡æ¢è´§å¸æ—¶ï¼Œæ¸…ç©ºè¾“å…¥æ¡†ï¼Œé˜²æ­¢æ•°å€¼æ··æ·†ï¼Œæˆ–è€…æ ¹æ®å½“å‰ç¨å‰æ”¶å…¥åå¡«
        // è¿™é‡Œé€‰æ‹©æ¸…ç©ºå¹¶åå¡«ç¬¬ä¸€ä¸ªï¼ˆç¨å‰ï¼‰ï¼Œç»™ç”¨æˆ·ç›´è§‚æ„Ÿå—
        const baseGross = state.incomes['nyc']; // ä»¥çº½çº¦ä¸ºåŸºå‡†
        document.getElementById('globalPreTax').value = Math.round(toDisplay(baseGross));
        document.getElementById('globalPostTax').value = '';
        document.getElementById('globalBigMac').value = '';
        document.getElementById('globalMultiple').value = '';
    }

    // å¤„ç†ç”Ÿæ´»æˆæœ¬ä¿®æ”¹
    function updateCost(sourceCity, category, subField, displayValue) {
        const val = parseFloat(displayValue) || 0;
        
        // æŸäº›å­—æ®µæ˜¯æ•°é‡/é¢ç§¯ï¼Œä¸éœ€è¦æ±‡ç‡è½¬æ¢
        const isQuantity = (subField === 'Area' || subField === 'HomeMeals' || subField === 'OutMeals');
        
        // è½¬æ¢ä¸º USD å­˜å‚¨
        const usdValue = isQuantity ? val : fromDisplay(val);

        const oldValue = subField 
            ? state.costs[sourceCity][category + subField] 
            : state.costs[sourceCity][category];

        const ratio = (oldValue === 0) ? 1 : (usdValue / oldValue);

        Object.keys(state.costs).forEach(cityKey => {
            if (!state.links[category] && cityKey !== sourceCity) return;
            const currentCityCost = state.costs[cityKey];
            
            if (cityKey === sourceCity) {
                if (subField) currentCityCost[category + subField] = usdValue;
                else currentCityCost[category] = usdValue;
            } else {
                if (subField) currentCityCost[category + subField] *= ratio;
                else currentCityCost[category] *= ratio;
            }
        });

        renderAll();
    }

    function calculateTotalCost(cityKey) {
        const c = state.costs[cityKey];
        const rent = c.rentArea * c.rentPrice * 12;
        const transport = (c.transPub + c.transTaxi) * 12;
        const food = ((c.foodHomeMeals * c.foodHomePrice) + (c.foodOutMeals * c.foodOutPrice)) * 12; 
        const social = c.social * 12;
        const misc = c.misc * 12;
        const travel = c.travel; 
        return rent + transport + food + social + misc + travel;
    }

    // --- 6. æ¸²æŸ“ ---

    function updateCurrencyLabels() {
        const symbol = `(${CURRENCIES[state.currency].symbol})`;
        document.querySelectorAll('.currency-label').forEach(el => el.innerText = symbol);
    }

    function renderAll() {
        updateCurrencyLabels();
        renderMainTable();
        renderCostTable();
    }

    function renderMainTable() {
        const tbody = document.getElementById('mainTableBody');
        tbody.innerHTML = '';

        Object.keys(CITIES_CONFIG).forEach(key => {
            const config = CITIES_CONFIG[key];
            const gross = state.incomes[key];
            const net = calculateNetIncome(gross, config.taxRegion);
            const bigMacIndex = net / config.bigMac;
            const totalCost = calculateTotalCost(key);
            const savings = net - totalCost;
            const multiple = gross / config.avgIncome;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-left font-bold">${config.name}</td>
                <td>${formatMoney(gross)}</td>
                <td style="color:#2563eb; font-weight:bold;">${formatMoney(net)}</td>
                <td style="color:#7c3aed; font-weight:bold;">${multiple.toFixed(1)}x</td>
                <td>${bigMacIndex.toLocaleString(undefined, {maximumFractionDigits:0})} ğŸ”</td>
                <td>${formatMoney(totalCost)}</td>
                <td class="${savings >= 0 ? 'positive' : 'negative'}">${formatMoney(savings)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderCostTable() {
        const tbody = document.getElementById('costTableBody');
        tbody.innerHTML = '';

        Object.keys(CITIES_CONFIG).forEach(key => {
            const c = state.costs[key];
            const name = CITIES_CONFIG[key].name;
            const total = calculateTotalCost(key);

            // è¾…åŠ©ï¼šè½¬ä¸ºæ˜¾ç¤ºå€¼å¹¶ä¿ç•™å°æ•°
            const d = (usd, fix=0) => toDisplay(usd).toFixed(fix);

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-left font-bold">${name}</td>
                
                <!-- Rent -->
                <td>
                    <div class="cost-input-group">
                        <input type="number" value="${c.rentArea}" onchange="updateCost('${key}', 'rent', 'Area', this.value)">
                        <span>ã¡ Ã—</span>
                        <input type="number" value="${d(c.rentPrice, 1)}" onchange="updateCost('${key}', 'rent', 'Price', this.value)">
                    </div>
                    <div class="sub-label text-right">${formatMoney(c.rentArea * c.rentPrice)}/æœˆ</div>
                </td>

                <!-- Transport -->
                <td>
                    <div class="cost-input-group">
                        <input type="number" value="${d(c.transPub)}" onchange="updateCost('${key}', 'trans', 'Pub', this.value)">
                        <span>+</span>
                        <input type="number" value="${d(c.transTaxi)}" onchange="updateCost('${key}', 'trans', 'Taxi', this.value)">
                    </div>
                    <div class="sub-label text-right">${formatMoney(c.transPub + c.transTaxi)}/æœˆ</div>
                </td>

                <!-- Food -->
                <td>
                    <div class="cost-input-group" style="margin-bottom:2px;">
                        <span>ğŸ </span>
                        <input type="number" value="${c.foodHomeMeals}" onchange="updateCost('${key}', 'food', 'HomeMeals', this.value)">
                        <span>Ã—</span>
                        <input type="number" value="${d(c.foodHomePrice, 1)}" onchange="updateCost('${key}', 'food', 'HomePrice', this.value)">
                    </div>
                    <div class="cost-input-group">
                        <span>ğŸ¥¡</span>
                        <input type="number" value="${c.foodOutMeals}" onchange="updateCost('${key}', 'food', 'OutMeals', this.value)">
                        <span>Ã—</span>
                        <input type="number" value="${d(c.foodOutPrice, 1)}" onchange="updateCost('${key}', 'food', 'OutPrice', this.value)">
                    </div>
                    <div class="sub-label text-right">æœˆåˆè®¡: ${formatMoney((c.foodHomeMeals*c.foodHomePrice) + (c.foodOutMeals*c.foodOutPrice))}</div>
                </td>

                <!-- Social -->
                <td>
                    <input type="number" value="${d(c.social)}" onchange="updateCost('${key}', 'social', null, this.value)">
                </td>

                <!-- Misc -->
                <td>
                    <input type="number" value="${d(c.misc)}" onchange="updateCost('${key}', 'misc', null, this.value)">
                </td>

                <!-- Travel -->
                <td>
                    <input type="number" value="${d(c.travel)}" onchange="updateCost('${key}', 'travel', null, this.value)">
                </td>

                <td style="font-weight:bold; background:#f1f5f9;">${formatMoney(total)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // åˆå§‹åŒ–
    document.getElementById('globalPreTax').value = 150000;
    handleGlobalInput('preTax', 150000);

</script>

</body>
</html>